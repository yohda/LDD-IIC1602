# Linux Device Driver(LDD) - IIC1602
### 목적
  - 취미로 진행하는 LDD를 만들고 있습니다. 실무에서 경험한 내용들과 개인 공부한 내용들을 풀어보려 합니다.
  
### 소개 
  - IIC1602는 I2C로 컨트롤되는 Character LCD(CLCD)를 말합니다. CLCD는 쉽고 결과물을 바로바로 확인할 수 있기 때문에, 처음 디바이스 드라이버를 접한다면 아주 좋은 선택이 될겁니다.  
  - 칩은 `PCF8574` + `HD44780(LCD)` 요렇게 두개가 합쳐진 칩입니다.
-----

개발 환경은 다음과 같습니다.
### 하드웨어
  - **라즈베리파이3 B**
  - **반드시 5V 2A 이상의 어댑터를 사용하세요.** 노트북에 꽂으면서 개발을 진행하면, 언제가 전류가 약해서 죽는 문제를 패닉으로 혹시나 오해하는 상황이 옵니다(라즈베리파이에서는 사실 5V-3A를 사용하라고 권고합니다). 
  
### 소프트웨어
  - **Linux kernel 5.10.103** 
    - 라즈비안 다운로드 시, 커널 버전은 5.10.103이하 라면 어떤 버전을 받든 상관없습니다. 이미지를 받더라도 결국 `sudo apt update & apt upgrade -y`를 통해 가장 stable한 버전으로 업그레이드를 해야합니다. 그 이렇게 번거로운 짓을 하는 이유는 라즈베리파이가 linux-hedaers가 기본적으로 다운로드 되어있지 않기 때문입니다. 모듈 빌드시에는 반드시 /lib/modules/${KERNEL_VERSION}/build/ 폴더가 커널 소스 및 리눅스 커널 헤더를 심볼릭 링크를 하고 있어야 정상적으로 빌드가 됩니다. 그런데 라즈베리파이에서 stable한 커널 버전에서만 linux-headers를 제공하기 때문에, 처음부터 stable한 버전을 받지 않는 이상 업데이트 및 업그레이드는 진행은 반드시 진행을 해야 합니다.
   
### 개발 환경
  - **Build** 
    - 라즈베리파이 모듈로 직접 빌드하는 환경을 꾸몄습니다. 소스 자체를 다운받은 것은 아닙니다. linux-heaers-${VERSION}을 자신의 라즈베리파이 버전과 동일하게 맞춰야 빌드가 정상적으로 진행될 것입니다.
    - 크로스 컴파일 환경은 추천하지 않습니다. 이유는 다음과 같습니다.
      1. 라즈베리파이가 속도가 느리더라도, 모듈만 빌드할 경우 결과적으로 실행 결과는 더 빠를 수 있습니다.
      2. 크로스 컴파일로 빌드를 할 경우, module_install 시, /lib/modules/${VERSION}/build 폴더의 심볼릭 링크에 문제가 발생합니다.
  
  - **PC와 라즈베리파이의 연결**
    1. UART - 가장 추천하는 방법입니다. UART를 이용하면 Boot-up 로그까지 모두 볼 수 있습니다.
    2. Ethernet SSH - 나쁘지 않습니다. Boot-up 로그까지 볼 수 있는지는 알아보지 않았지만, Wifi 방법보다는 좋다고 생각됩니다.
    3. Wifi SSH - 위에 2가지 상황이 안될 경우 그나마 해볼 수 있는 상황이 생각됩니다. 해당 방법은 변수가 많아 좋아하지 않습니다(라즈베리파이3의 경우 고질적인 wifi 문제가 있습니다..).
----
### 소스 설명
1. PCF8574T는 하나의 레지스터만 존재하는 I/O Expander 입니다. 그래서 regmap을 사용하지 않고, i2c_smbus_write_byte / i2c_smbus_read_byte 를 통해 PCF8574
